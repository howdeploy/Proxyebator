---
phase: 05-uninstall-and-robustness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - proxyebator.sh
autonomous: true
requirements:
  - DEL-01
  - DEL-02

must_haves:
  truths:
    - "Running ./proxyebator.sh uninstall reads /etc/proxyebator/server.conf and removes all artifacts without prompting for config values"
    - "Running ./proxyebator.sh uninstall --yes skips the confirmation prompt"
    - "After uninstall, systemctl status proxyebator returns 'not found' or inactive"
    - "After uninstall, /usr/local/bin/chisel does not exist"
    - "After uninstall, the nginx config file recorded in NGINX_CONF is removed and nginx is reloaded"
    - "After uninstall, firewall rules for 80, LISTEN_PORT, and 7777 are removed"
    - "After uninstall, /etc/proxyebator/ directory is removed"
    - "TLS certificate is NOT removed (Let's Encrypt rate limits)"
    - "Running uninstall twice does not error out (idempotent removal)"
  artifacts:
    - path: "proxyebator.sh"
      provides: "uninstall_main with sub-functions, --yes flag, NGINX_INJECTED in server_save_config"
      contains: "uninstall_main"
  key_links:
    - from: "uninstall_main"
      to: "/etc/proxyebator/server.conf"
      via: "source command"
      pattern: "source /etc/proxyebator/server.conf"
    - from: "CLI parser"
      to: "uninstall_main"
      via: "--yes flag sets UNINSTALL_YES=true"
      pattern: "--yes.*UNINSTALL_YES"
    - from: "server_save_config"
      to: "uninstall_main"
      via: "NGINX_INJECTED flag enables safe nginx cleanup"
      pattern: "NGINX_INJECTED"
---

<objective>
Implement the complete `uninstall` command that reads server.conf and removes all proxyebator-installed artifacts in reverse-install order.

Purpose: Users must be able to cleanly remove all components without manually tracking what was installed. The uninstall must work without any interactive prompts (reads config), support `--yes` for non-interactive usage, and be safe to run multiple times.

Output: Working `./proxyebator.sh uninstall` command that removes systemd service, binary, auth file, nginx config, and firewall rules.
</objective>

<execution_context>
@/home/kosya/.claude/get-shit-done/workflows/execute-plan.md
@/home/kosya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-uninstall-and-robustness/05-RESEARCH.md
@proxyebator.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NGINX_INJECTED flag to server_save_config and --yes flag to CLI parser</name>
  <files>proxyebator.sh</files>
  <action>
Two small changes to support the uninstall:

1. **Add NGINX_INJECTED to server_save_config() (line ~947):**
   After the `NGINX_CONF=` line in the heredoc (line ~961), add:
   ```
   NGINX_INJECTED=${NGINX_INJECTED:-false}
   ```
   This records whether the tunnel block was injected into a pre-existing nginx config (vs. a fresh config created by proxyebator). The variable `NGINX_INJECTED` must be set in `server_configure_nginx()`:
   - In the `if [[ -n "${NGINX_EXISTING_CONF:-}" ]]` branch (line ~740), add `NGINX_INJECTED="true"` before `NGINX_CONF_PATH="$NGINX_EXISTING_CONF"`
   - In the `else` branch (line ~771), add `NGINX_INJECTED="false"` before `NGINX_CONF_PATH="${NGINX_CONF_DIR}/..."`

2. **Add --yes flag to CLI parser (line ~1297 while loop):**
   Add a new case before the `*) die` catch-all (line ~1314):
   ```
   --yes)        UNINSTALL_YES="true"; shift ;;
   ```
   Also initialize `UNINSTALL_YES=""` in the variable initialization block (around line ~1290).

These are two surgical additions: one line in the parser, one line in config save, two lines in nginx config function.
  </action>
  <verify>
Run: `grep -n 'NGINX_INJECTED' proxyebator.sh` — should show 3+ occurrences (set in nginx function, written in save_config, initialized).
Run: `grep -n '\-\-yes' proxyebator.sh` — should show the CLI parser case.
Run: `bash -n proxyebator.sh` — must exit 0 (no syntax errors).
  </verify>
  <done>
NGINX_INJECTED flag is written to server.conf during install. --yes flag is parsed by CLI. Script passes syntax check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement uninstall_main with all sub-functions</name>
  <files>proxyebator.sh</files>
  <action>
Replace the stub `uninstall_main()` at line ~1258 with the full implementation. Use private sub-functions prefixed with `_uninstall_` for each removal step. All sub-functions must be guarded with existence checks so uninstall is idempotent (safe to run twice). Every removal uses `|| true` or `[[ -f ]]` guards because `set -euo pipefail` is active.

**Structure of uninstall_main():**
```bash
uninstall_main() {
    check_root
    detect_os   # needed for NGINX_CONF_LINK

    [[ -f /etc/proxyebator/server.conf ]] \
        || die "No installation found at /etc/proxyebator/server.conf"
    # shellcheck disable=SC1091
    source /etc/proxyebator/server.conf

    _uninstall_confirm
    _uninstall_service
    _uninstall_binary
    _uninstall_nginx
    _uninstall_firewall
    _uninstall_config

    log_info "Uninstall complete"
    log_info "TLS certificate preserved at: /etc/letsencrypt/live/${DOMAIN:-unknown}/"
    log_info "To remove certificate: certbot delete --cert-name ${DOMAIN:-unknown}"
}
```

**Sub-functions (define them immediately above uninstall_main):**

1. **_uninstall_confirm():**
   - If `UNINSTALL_YES` is "true", return immediately (skip confirmation).
   - Otherwise print what will be removed (chisel binary, service, nginx config path from $NGINX_CONF, firewall rules for ports 80/$LISTEN_PORT/7777) using printf with YELLOW/CYAN colors.
   - Prompt `[y/N]` and abort if not y/Y/yes/YES.
   - Use `${NGINX_CONF:-unknown}` and `${LISTEN_PORT:-443}` to handle potentially empty values from server.conf.

2. **_uninstall_service():**
   ```bash
   _uninstall_service() {
       if systemctl is-active --quiet proxyebator 2>/dev/null; then
           systemctl stop proxyebator 2>/dev/null || true
           log_info "Stopped proxyebator.service"
       fi
       if systemctl is-enabled --quiet proxyebator 2>/dev/null; then
           systemctl disable proxyebator 2>/dev/null || true
       fi
       if [[ -f /etc/systemd/system/proxyebator.service ]]; then
           rm -f /etc/systemd/system/proxyebator.service
           systemctl daemon-reload
           systemctl reset-failed 2>/dev/null || true
           log_info "Removed proxyebator.service"
       else
           log_info "proxyebator.service: not found, skipping"
       fi
   }
   ```

3. **_uninstall_binary():**
   ```bash
   _uninstall_binary() {
       if [[ -f /usr/local/bin/chisel ]]; then
           rm -f /usr/local/bin/chisel
           log_info "Removed /usr/local/bin/chisel"
       else
           log_info "Chisel binary: not found, skipping"
       fi
       if [[ -f /etc/chisel/auth.json ]]; then
           rm -f /etc/chisel/auth.json
           log_info "Removed /etc/chisel/auth.json"
       fi
       rmdir /etc/chisel 2>/dev/null || true
   }
   ```
   Use `rmdir` (not `rm -rf`) to preserve user files in `/etc/chisel/`.

4. **_uninstall_nginx():**
   - If `NGINX_INJECTED` is "true": do NOT delete the file. Instead, if the file exists and contains `proxyebator-tunnel-block-start`, use `sed` to remove lines between `# proxyebator-tunnel-block-start` and `# proxyebator-tunnel-block-end` (inclusive). Log "Removed tunnel block from existing nginx config".
   - If `NGINX_INJECTED` is NOT "true" (empty or "false"): delete the file `$NGINX_CONF` if it exists. Also remove the symlink: call `detect_os` already done at top, so `NGINX_CONF_LINK` is set. If `NGINX_CONF_LINK` is non-empty, `rm -f "${NGINX_CONF_LINK}/$(basename "${NGINX_CONF}")"`. Also remove backup files: `rm -f "${NGINX_CONF}.bak."* 2>/dev/null || true`.
   - After removal, if nginx is running (`systemctl is-active --quiet nginx`), run `nginx -t 2>/dev/null && systemctl reload nginx || true`.
   - Use `${NGINX_CONF:-}` guards throughout.

5. **_uninstall_firewall():**
   Mirror the install logic structure exactly:
   - If `ufw` is installed AND active (`ufw status | grep "Status: active"`):
     ```bash
     ufw delete allow 80/tcp 2>/dev/null || true
     ufw delete allow "${LISTEN_PORT:-443}/tcp" 2>/dev/null || true
     ufw delete deny 7777/tcp 2>/dev/null || true
     ```
   - Else (iptables path):
     ```bash
     iptables -D INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null || true
     iptables -D INPUT -p tcp --dport "${LISTEN_PORT:-443}" -j ACCEPT 2>/dev/null || true
     iptables -D INPUT -p tcp --dport 7777 ! -i lo -j DROP 2>/dev/null || true
     ```
   - Log which method was used.
   - The `! -i lo` in the iptables `-D` command MUST match the `-A` command from install exactly.

6. **_uninstall_config():**
   ```bash
   _uninstall_config() {
       rm -f /etc/proxyebator/server.conf
       rmdir /etc/proxyebator 2>/dev/null || true
       log_info "Removed /etc/proxyebator/"
   }
   ```
   This is LAST because all previous steps read variables from server.conf (already sourced at top of uninstall_main).

**Important implementation notes:**
- Do NOT remove TLS certificate or certbot timer.
- Do NOT remove temp files in /tmp (they are transient).
- Do NOT use `rm -rf` anywhere — only `rm -f` for files and `rmdir` for directories.
- Every `systemctl` and `rm` call that might fail must have `|| true` or be inside `[[ -f ]]` / `is-active` guards.
- All sub-functions use `log_info` for status messages, matching existing script style.
- The `sed` command for tunnel block removal: `sed -i '/# proxyebator-tunnel-block-start/,/# proxyebator-tunnel-block-end/d' "$NGINX_CONF"`.

**Also update print_usage():**
Add to the EXAMPLES section:
```
  # Non-interactive uninstall
  sudo $(basename "$0") uninstall --yes
```
  </action>
  <verify>
Run: `bash -n proxyebator.sh` — must exit 0 (no syntax errors).
Run: `grep -c '_uninstall_' proxyebator.sh` — should show 10+ occurrences (6 function definitions + calls from uninstall_main).
Run: `grep 'UNINSTALL_YES' proxyebator.sh` — should show usage in _uninstall_confirm and CLI parser.
Verify the uninstall dispatch: `grep -A2 'uninstall)' proxyebator.sh` — should call uninstall_main.
  </verify>
  <done>
`./proxyebator.sh uninstall` reads server.conf, confirms (unless --yes), and removes all artifacts in reverse order. Running uninstall twice does not error. TLS cert is preserved.
  </done>
</task>

</tasks>

<verification>
1. `bash -n proxyebator.sh` exits 0 — no syntax errors
2. `grep -c 'uninstall' proxyebator.sh` shows significant count (function + sub-functions + CLI)
3. `grep 'NGINX_INJECTED' proxyebator.sh` shows the flag in server_configure_nginx, server_save_config
4. `grep '\-\-yes' proxyebator.sh` shows the flag in CLI parser and _uninstall_confirm
5. Code review: every `rm`, `systemctl stop/disable`, `iptables -D`, `ufw delete` has `|| true` or `[[ -f ]]` guard
</verification>

<success_criteria>
- uninstall_main() with 6 sub-functions replaces the stub
- --yes flag parsed in CLI, used in _uninstall_confirm
- NGINX_INJECTED flag written to server.conf, read during uninstall for safe nginx cleanup
- All removal steps guarded for idempotency
- TLS certificate explicitly NOT removed
- bash -n passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-uninstall-and-robustness/05-01-SUMMARY.md`
</output>
