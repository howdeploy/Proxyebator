---
phase: 03-verification-suite
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified: [proxyebator.sh]
autonomous: true
requirements: [VER-03]

must_haves:
  truths:
    - "Running ./proxyebator.sh verify prints all 7 checks and summary"
    - "server_main() calls verify_main() instead of server_verify()"
    - "server_verify() function no longer exists in the script"
    - "After all checks pass, connection block shows host, port, secret path, auth token, and client command"
    - "verify_main exit code propagates through server_main (exit 1 on any fail)"
  artifacts:
    - path: "proxyebator.sh"
      provides: "CLI verify mode, server_main wiring, old function removed"
      contains: "verify)"
  key_links:
    - from: "CLI dispatcher case $1"
      to: "verify_main()"
      via: "verify) MODE=verify then case $MODE dispatch"
      pattern: "verify.*verify_main"
    - from: "server_main()"
      to: "verify_main()"
      via: "direct call replacing server_verify"
      pattern: "server_main.*verify_main"
---

<objective>
Wire verify_main() into the CLI dispatcher as a standalone `verify` command, replace server_verify() in server_main() with verify_main(), and remove the old server_verify() function.

Purpose: Makes the verification suite accessible both as post-install automatic check AND as a standalone re-runnable command (`./proxyebator.sh verify`). Fulfills VER-03 by ensuring connection info is printed after successful verification.
Output: Complete wiring — verify works standalone and as part of server install. Old dead code removed.
</objective>

<execution_context>
@/home/kosya/.claude/get-shit-done/workflows/execute-plan.md
@/home/kosya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-verification-suite/03-CONTEXT.md
@.planning/phases/03-verification-suite/03-RESEARCH.md
@.planning/phases/03-verification-suite/03-01-SUMMARY.md
@proxyebator.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire verify into CLI dispatcher and update server_main</name>
  <files>proxyebator.sh</files>
  <action>
Three changes to proxyebator.sh, referencing research pitfall 6 (both case statements must be updated):

**1. CLI mode extraction (around line 848-852):**
Add `verify` to the first case statement:
```
case "$1" in
    server|client|uninstall|verify) MODE="$1"; shift ;;
```

**2. CLI dispatch (around line 872-876):**
Add verify case:
```
case "$MODE" in
    server)    server_main ;;
    client)    client_main ;;
    uninstall) uninstall_main ;;
    verify)    check_root; verify_main; exit $? ;;
esac
```
Note: `check_root` before `verify_main` — verify needs root for ss, systemctl, iptables. `exit $?` propagates verify_main's return code (0 or 1).

**3. server_main() update:**
Replace the `server_verify` call with `verify_main` and propagate exit code:
```
server_main() {
    check_root
    detect_os
    detect_arch
    server_collect_params
    server_show_summary
    server_install_deps
    server_download_chisel
    server_setup_auth
    server_create_systemd
    server_configure_nginx
    server_obtain_tls
    server_configure_firewall
    server_save_config
    verify_main || exit 1
}
```
The `|| exit 1` ensures that if verify_main returns 1 (checks failed), server_main exits non-zero. Under `set -e`, a bare `verify_main` returning 1 would kill the script — but with `|| exit 1` we explicitly handle it.

**4. Update print_usage():**
Add `verify` to the usage output so users know the command exists. Find the usage printf lines and add:
```
printf "  ${BOLD}verify${NC}      Run post-install verification checks\n"
```
Place it after the existing mode lines (server, client, uninstall).

**5. Delete server_verify() function:**
Remove the entire server_verify() function (lines ~756-811 in current script). This is dead code after verify_main replaces it. Do NOT keep it commented out.

Also remove `server_print_connection_info` from any location outside verify_main — it should ONLY be called from verify_main's all-pass branch now. (Check: currently server_verify calls it unconditionally at line 810 — that entire function is deleted, so this is handled.)

IMPORTANT: server_print_connection_info() function itself MUST be preserved — it is called by verify_main. Only the CALL from server_verify is removed (by deleting server_verify entirely).
  </action>
  <verify>
1. `bash -n proxyebator.sh` returns 0 (syntax valid after all changes)
2. `grep "verify)" proxyebator.sh` shows verify in both case statements
3. `grep "server_verify" proxyebator.sh` returns 0 matches (function fully removed)
4. `grep "verify_main" proxyebator.sh` shows calls from both server_main and CLI dispatcher
5. `grep "verify.*Run post-install" proxyebator.sh` shows usage line
6. `grep "server_print_connection_info" proxyebator.sh` shows the function definition AND its call inside verify_main — nowhere else
  </verify>
  <done>
- `./proxyebator.sh verify` dispatches to check_root + verify_main
- `./proxyebator.sh server` runs full install then verify_main (not old server_verify)
- server_verify() function completely removed
- print_usage shows verify command
- Script passes bash -n syntax check
- Exit code 1 propagates when any check fails
  </done>
</task>

</tasks>

<verification>
1. `bash -n proxyebator.sh` — syntax valid
2. `grep -c "server_verify" proxyebator.sh` — returns 0 (dead code removed)
3. `grep "verify_main" proxyebator.sh` — appears in function definition, server_main call, and CLI dispatcher
4. `grep "verify)" proxyebator.sh` — appears in BOTH case statements (mode extraction AND dispatch)
5. `grep "exit \$?" proxyebator.sh` — in verify CLI dispatch line
6. print_usage mentions verify command
</verification>

<success_criteria>
- `./proxyebator.sh verify` is a valid command that runs all 7 checks
- server_main ends with verify_main, exits non-zero on failure
- Old server_verify() fully deleted (zero references remain)
- Connection block (host, port, secret path, auth token, client command) prints ONLY after ALL PASS
- Usage text shows verify as available command
- Script syntax valid (bash -n)
</success_criteria>

<output>
After completion, create `.planning/phases/03-verification-suite/03-02-SUMMARY.md`
</output>
