# Phase 2: Server Core - Context

**Gathered:** 2026-02-18
**Status:** Ready for planning

<domain>
## Phase Boundary

Полная серверная установка: зависимости, скачивание бинарника Chisel, nginx reverse proxy с сайтом-обманкой, TLS через certbot, systemd сервис, firewall. Пользователь запускает `./proxyebator.sh server`, отвечает на вопросы — получает работающий замаскированный туннель. wstunnel — Phase 6.

</domain>

<decisions>
## Implementation Decisions

### Интерактивный flow
- Режим «по шагам с прогрессом»: спросить домен → поставить зависимости → спросить туннель → скачать бинарник → спросить маскировку → настроить nginx → и т.д. Каждый шаг виден пользователю
- Перед началом установки показать сводку всех параметров с подтверждением: «Домен: X, Туннель: Y, Маскировка: Z. Продолжить? [y/N]»
- Non-interactive режим (через CLI-флаги из Phase 1) пропускает вопросы и сводку

### Валидация домена
- Формат + DNS-проверка: убедиться что A-запись домена указывает на IP текущего сервера
- Домен обязателен — режим без домена (IP-only) не поддерживается
- Предупреждение о Cloudflare: если домен резолвится в CF IP (оранжевое облако) — предупредить что WebSocket может таймаутить

### Сайт-обманка (маскировка)
- Режим HTTPS-only (MASK-06) **убран** — nginx используется всегда
- Три режима маскировки:
  - **stub** — минималистичная HTML-страница с заголовком «Welcome» и минимумом текста (похоже на новый сайт)
  - **proxy** — пользователь вводит URL сайта (напр. https://example.blog), nginx проксирует его на /
  - **static** — пользователь указывает путь к папке со своими файлами на сервере, nginx root = эта папка

### Выбор туннеля и порт
- Chisel по умолчанию (рекомендуется), wstunnel как альтернатива (Phase 2 ставит только Chisel; wstunnel — Phase 6)
- Внутренний порт фиксированный: Chisel 7777, wstunnel 8888
- Внешний порт (nginx listen): автодетект — если 443 занят, показать кто занимает и предложить 2087/8443/свой порт

### Firewall
- ufw приоритет, iptables fallback: если ufw установлен — использовать ufw, иначе iptables
- Открыть 80/443 (или альтернативный порт), заблокировать порт туннеля снаружи

### Существующая инфраструктура
- Если nginx уже настроен для домена — добавить WebSocket location в существующий server block, не трогать остальное
- Если TLS-сертификат уже есть (certbot или другой) — переиспользовать его, не выпускать новый

### Claude's Discretion
- Точная последовательность установки внутри каждого шага
- Как именно детектировать существующий nginx конфиг и TLS-сертификат
- Формат сводки перед установкой
- Как проверить что CF проксирует домен
- Размер и содержание stub-страницы

</decisions>

<specifics>
## Specific Ideas

- Референс реализации в `tunnel-reference.md` и `PROXY-GUIDE.md` — содержат рабочие конфиги Chisel/wstunnel, nginx location block, systemd unit, критичные детали (trailing slash, proxy_buffering off, --host и -p раздельно)
- Формат auth: файл `/etc/chisel/auth.json` с `chmod 600` (пароль в `--auth` виден через `ps aux`)
- `[".*:.*"]` в authfile для разрешения всех remotes (пустая строка `[""]` может не работать)
- `--reverse` НЕ нужен для SOCKS5 (убирает attack surface)
- Если порт 443 занят другим сервисом (Xray, VPN) — скрипт должен это обнаружить и предложить альтернативу
- Cloudflare orange cloud блокирует бинарные WebSocket данные — серое облако для прямого подключения

</specifics>

<deferred>
## Deferred Ideas

- wstunnel как реальная альтернатива — Phase 6
- Cloudflare CDN маршрутизация (domain fronting) — v2 (CDN-01)
- Автообновление бинарника — v2 (UPD-01)

</deferred>

---

*Phase: 02-server-core*
*Context gathered: 2026-02-18*
