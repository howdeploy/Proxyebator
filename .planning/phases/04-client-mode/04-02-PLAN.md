---
phase: 04-client-mode
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - proxyebator.sh
autonomous: true
requirements:
  - CLI-01
  - CLI-03
  - CLI-04

must_haves:
  truths:
    - "client_download_chisel() downloads Chisel for the detected OS/arch and installs to a user-writable location without root"
    - "On macOS, xattr quarantine is removed from the downloaded binary"
    - "client_check_socks_port() detects occupied port 1080 and prompts for alternative"
    - "client_run() launches chisel in foreground with exec, building https:// URL from params"
    - "GUI instructions are printed in Russian before chisel exec, including Throne, Proxifier, nekoray, Firefox, Chrome, Surge"
    - "server_print_connection_info() includes a wss:// URL command for proxyebator.sh client"
    - "Port check works on both Linux (ss) and macOS (lsof)"
  artifacts:
    - path: "proxyebator.sh"
      provides: "Client binary download, SOCKS5 port check, foreground chisel launch, GUI instructions, server wss:// URL"
      contains: "client_download_chisel"
  key_links:
    - from: "client_collect_params() [Plan 01]"
      to: "client_run()"
      via: "Global variables CLIENT_HOST, CLIENT_PORT, CLIENT_PATH, CLIENT_USER, CLIENT_PASS, SOCKS_PORT"
      pattern: "CLIENT_HOST.*CLIENT_PORT.*CLIENT_PATH"
    - from: "client_run()"
      to: "chisel client binary"
      via: "exec with --auth and https:// URL"
      pattern: 'exec.*chisel.*client.*--auth'
    - from: "server_print_connection_info()"
      to: "client_parse_url() [Plan 01]"
      via: "wss:// URL format printed by server, consumed by client URL parser"
      pattern: "proxyebator.sh client wss://"
---

<objective>
Implement client binary download, SOCKS5 port check, foreground chisel launch, GUI setup instructions, and update server to print wss:// client URL.

Purpose: This plan completes client mode — after Plan 01 collects params, this plan downloads the binary, validates the port, prints instructions, and launches the tunnel. The server wss:// URL update ensures discoverability.

Output: Fully functional `./proxyebator.sh client` command.
</objective>

<execution_context>
@/home/kosya/.claude/get-shit-done/workflows/execute-plan.md
@/home/kosya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-client-mode/04-RESEARCH.md
@.planning/phases/04-client-mode/04-01-SUMMARY.md
@proxyebator.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement client_download_chisel, client_check_socks_port, client_print_gui_instructions</name>
  <files>proxyebator.sh</files>
  <action>
  Add these functions AFTER the client_collect_params/client_collect_interactive section (from Plan 01) and BEFORE client_main().

  1. **client_download_chisel()** — Downloads Chisel for CLIENT_OS/ARCH, installs to user-writable location.

  Key requirements:
  - Check if `chisel` is already in PATH — skip download if found, set CHISEL_BIN
  - Install location priority: /usr/local/bin (if writable without root), else ~/.local/bin (create if needed)
  - Warn if ~/.local/bin is not in PATH
  - Version detection: GitHub API latest release (same pattern as server_download_chisel), v1.11.3 fallback
  - Asset URL: `chisel_${VER}_${CLIENT_OS}_${ARCH}.gz` (NOT linux-only; uses CLIENT_OS from detect_client_os)
  - Download to /tmp/chisel_client.gz, gunzip, chmod +x
  - macOS: `xattr -d com.apple.quarantine /tmp/chisel_client 2>/dev/null || true`
  - Move to install_dir/chisel
  - Verify with `"${install_dir}/chisel" --version`
  - Set global CHISEL_BIN="${install_dir}/chisel"

  Implementation from research Pattern 5 (04-RESEARCH.md). Full code provided there.

  2. **client_check_socks_port()** — Checks if SOCKS_PORT is free before launch.

  Key requirements:
  - SOCKS_PORT defaults to CLIENT_SOCKS_PORT or 1080
  - Cross-platform port check: `ss -tlnp` on Linux/WSL, `lsof -i :PORT` on macOS
  - Define nested `_port_in_use()` helper
  - If port occupied: prompt for alternative (default 1081)
  - If alternative also occupied: die with message suggesting --socks-port
  - Log the final SOCKS5 address

  Implementation from research Pattern 6 (04-RESEARCH.md).

  3. **client_print_gui_instructions()** — Prints SOCKS5 setup instructions in Russian.

  Key requirements:
  - Print SOCKS5 params block: address (127.0.0.1), port (SOCKS_PORT), protocol (SOCKS5), DNS (through proxy)
  - Print per-client instructions (1-2 lines each): Throne (Linux), nekoray (Linux/Windows), Proxifier (Win/Mac), Surge (macOS), Firefox, Chrome (SwitchyOmega)
  - Print curl verification command: `curl --socks5-hostname localhost:PORT https://ifconfig.me`
  - Print note: "(должен вернуть IP сервера, не ваш)"
  - All text in Russian per CONTEXT.md locked decision
  - Use existing color constants: BOLD, CYAN, NC

  Implementation from research Pattern 8 (04-RESEARCH.md). Exact output format provided there.
  </action>
  <verify>
  Run `bash -n proxyebator.sh` — no syntax errors.

  Test that functions exist:
  ```bash
  bash proxyebator.sh client "wss://proxyebator:tok@host.com:443/path/" 2>&1 | head -20
  ```
  Should show "Client OS: linux", "URL parsed:", then attempt to download chisel (will fail on network but function is wired).
  </verify>
  <done>client_download_chisel() downloads cross-platform binary to user-writable location with macOS quarantine removal. client_check_socks_port() checks port with ss/lsof cross-platform. client_print_gui_instructions() prints Russian setup instructions for 6 GUI clients.</done>
</task>

<task type="auto">
  <name>Task 2: Implement client_run, wire client_main, update server wss:// URL</name>
  <files>proxyebator.sh</files>
  <action>
  1. **client_run()** — Builds chisel command and execs in foreground.

  Key requirements:
  - Build chisel URL: `https://${CLIENT_HOST}:${CLIENT_PORT}${CLIENT_PATH}` (always https://, never wss://)
  - Build SOCKS arg: `socks` for port 1080, `${SOCKS_PORT}:socks` for custom port
  - Print GUI instructions BEFORE exec (user sees them even if chisel crashes immediately)
  - Log "Запуск Chisel клиента... (Ctrl+C для остановки)"
  - Use `exec "${CHISEL_BIN:-chisel}" client --auth "${CLIENT_USER}:${CLIENT_PASS}" --keepalive 25s "${chisel_url}" "${socks_arg}"`
  - exec replaces shell — code after this line never runs. This is the correct pattern for foreground-only mode per CONTEXT.md.

  Implementation from research Pattern 7 (04-RESEARCH.md).

  2. **Wire client_main()** — Replace the Plan 01 stub with full pipeline:

  ```bash
  client_main() {
      detect_arch
      detect_client_os
      client_collect_params
      client_download_chisel
      client_check_socks_port
      client_run
      # Note: client_run() uses exec — this line never executes
  }
  ```

  Do NOT add check_root() — client mode does not need root.

  3. **Update server_print_connection_info()** — Add wss:// URL line for proxyebator.sh client.

  After the existing chisel client command block and before the "SOCKS5 proxy will be available at" line, add:

  ```bash
  printf "  ${BOLD}Команда для клиентской машины:${NC}\n"
  printf "  ${CYAN}./proxyebator.sh client wss://%s:%s@%s:%s/%s/${NC}\n" \
      "${AUTH_USER}" "${AUTH_TOKEN}" "${DOMAIN}" "${LISTEN_PORT}" "${SECRET_PATH}"
  printf "\n"
  ```

  This makes client mode discoverable from server output — user copies one line and runs it on their machine.

  4. **Update print_usage()** — Remove `sudo` from the client example line (client does not need root). If not already done in Plan 01, ensure the client example reads:
  ```
  # Connect client (copy from server output)
  $(basename "$0") client wss://proxyebator:TOKEN@example.com/SECRET/
  ```
  </action>
  <verify>
  Run `bash -n proxyebator.sh` — no syntax errors.

  Verify client_main pipeline:
  ```bash
  bash proxyebator.sh client "wss://proxyebator:tok@host.com:443/path/" 2>&1 | head -30
  ```
  Expected: Shows detect_arch, detect_client_os, URL parsed, then attempts chisel download.

  Verify server_print_connection_info has wss:// line:
  ```bash
  grep -c "proxyebator.sh client wss://" proxyebator.sh
  ```
  Expected: 1 (or more if also in usage examples)

  Verify no check_root in client_main:
  ```bash
  grep -A 10 'client_main()' proxyebator.sh | grep -c check_root
  ```
  Expected: 0
  </verify>
  <done>client_run() launches chisel in foreground via exec with https:// URL. client_main() is a complete pipeline: detect_arch -> detect_client_os -> collect_params -> download_chisel -> check_socks_port -> run. server_print_connection_info() prints wss:// URL for copy-paste. No root check in client mode.</done>
</task>

</tasks>

<verification>
1. `bash -n proxyebator.sh` passes (no syntax errors)
2. `bash proxyebator.sh client "wss://proxyebator:tok@host.com:443/path/"` attempts to download chisel (proves full pipeline is wired)
3. `grep "proxyebator.sh client wss://" proxyebator.sh` finds the server output line
4. `grep -A 10 'client_main()' proxyebator.sh` shows detect_arch, detect_client_os, client_collect_params, client_download_chisel, client_check_socks_port, client_run — no check_root
5. `grep "Throne\|Proxifier\|nekoray\|Surge\|Firefox\|Chrome" proxyebator.sh` finds all 6 GUI clients in instructions
6. `grep "curl --socks5-hostname" proxyebator.sh` finds verification command in GUI instructions
7. `grep "xattr.*quarantine" proxyebator.sh` finds macOS Gatekeeper handling
</verification>

<success_criteria>
- `./proxyebator.sh client wss://user:pass@host:443/path/` downloads binary, checks port, prints GUI instructions, and execs chisel
- Binary downloads to ~/.local/bin if /usr/local/bin is not writable (no root needed)
- macOS quarantine attribute removed from downloaded binary
- SOCKS5 port check works cross-platform (ss on Linux, lsof on macOS)
- GUI instructions printed in Russian for 6 clients before chisel launch
- curl verification command included in output
- server_print_connection_info includes wss:// URL
- chisel launched in foreground via exec (no background, no PID files)
</success_criteria>

<output>
After completion, create `.planning/phases/04-client-mode/04-02-SUMMARY.md`
</output>
