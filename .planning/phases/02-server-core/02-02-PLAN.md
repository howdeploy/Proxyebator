---
phase: 02-server-core
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - proxyebator.sh
autonomous: true
requirements:
  - TUNNEL-02
  - TUNNEL-03
  - TUNNEL-07
  - SRV-01

must_haves:
  truths:
    - "Chisel binary is downloaded from GitHub releases with version auto-detection and architecture-aware URL"
    - "Auth credentials are stored in /etc/chisel/auth.json with chmod 600, not in command-line arguments"
    - "systemd service starts Chisel with --host 127.0.0.1 and -p 7777 as separate flags"
    - "systemd service uses --authfile and --socks5 flags, does NOT use --reverse"
    - "Service runs as User=nobody with Restart=always"
  artifacts:
    - path: "proxyebator.sh"
      provides: "server_download_chisel, server_setup_auth, server_create_systemd functions"
      contains: "server_download_chisel"
    - path: "/etc/chisel/auth.json"
      provides: "Chisel authentication credentials file"
      contains: ".*:.*"
    - path: "/etc/systemd/system/proxyebator.service"
      provides: "systemd unit file for Chisel tunnel"
      contains: "--host 127.0.0.1"
  key_links:
    - from: "server_main()"
      to: "server_download_chisel()"
      via: "function call after server_install_deps"
      pattern: "server_download_chisel"
    - from: "server_download_chisel()"
      to: "GitHub API"
      via: "curl to releases/latest"
      pattern: "api.github.com/repos/jpillora/chisel"
    - from: "server_create_systemd()"
      to: "/etc/chisel/auth.json"
      via: "--authfile flag in ExecStart"
      pattern: "--authfile /etc/chisel/auth.json"
---

<objective>
Download the Chisel binary from GitHub releases, create the authentication file, and set up the systemd service unit.

Purpose: The tunnel binary and its service are the core of the product --- without them, nothing works. Auth must be stored in a file (not CLI args) for security. The systemd unit must use the exact flag format that prevents Chisel from binding to 0.0.0.0.

Output: server_download_chisel(), server_setup_auth(), server_create_systemd() functions wired into server_main().
</objective>

<execution_context>
@/home/kosya/.claude/get-shit-done/workflows/execute-plan.md
@/home/kosya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-core/02-RESEARCH.md
@.planning/phases/02-server-core/02-CONTEXT.md
@.planning/phases/02-server-core/02-01-SUMMARY.md
@proxyebator.sh
@tunnel-reference.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Chisel binary download and auth file creation</name>
  <files>proxyebator.sh</files>
  <action>
Add two functions to proxyebator.sh, inserting them after server_install_deps() and before server_main().

**server_download_chisel():**
- Define fallback version: `local CHISEL_FALLBACK_VER="v1.11.3"`
- Fetch latest version from GitHub API:
  ```bash
  local CHISEL_VER
  CHISEL_VER=$(curl -sf --max-time 10 \
      "https://api.github.com/repos/jpillora/chisel/releases/latest" \
      | grep -o '"tag_name": "[^"]*"' | grep -o 'v[0-9.]*') \
      || CHISEL_VER=""
  ```
- If empty or fetch failed, use fallback: `[[ -n "$CHISEL_VER" ]] || CHISEL_VER="$CHISEL_FALLBACK_VER"` and log_warn
- Build download URL: `"https://github.com/jpillora/chisel/releases/download/${CHISEL_VER}/chisel_${CHISEL_VER#v}_linux_${ARCH}.gz"`
  - NOTE: Asset format is `.gz` (not `.tar.gz`). Use `gunzip`, not `tar`.
  - NOTE: Use `${ARCH}` from detect_arch() (Phase 1) --- never hardcode amd64.
- Download, extract, install:
  ```bash
  curl -fLo /tmp/chisel.gz "$download_url" || die "Failed to download Chisel from $download_url"
  gunzip -f /tmp/chisel.gz
  chmod +x /tmp/chisel
  mv /tmp/chisel /usr/local/bin/chisel
  ```
- Verify binary works: `/usr/local/bin/chisel --version || die "Chisel binary not working after install"`
- Log installed version: `log_info "Chisel installed: $(/usr/local/bin/chisel --version 2>&1 | head -1)"`

**server_setup_auth():**
- Create directories: `mkdir -p /etc/chisel` and `mkdir -p /etc/proxyebator`
- Write auth.json using the SECRET_PATH, AUTH_USER, AUTH_TOKEN variables set in server_collect_params:
  ```bash
  cat > /etc/chisel/auth.json << EOF
  {
    "${AUTH_USER}:${AUTH_TOKEN}": [".*:.*"]
  }
  EOF
  ```
- CRITICAL: Use `[".*:.*"]` NOT `[""]` --- empty string does not work.
- Set permissions: `chmod 600 /etc/chisel/auth.json`
- Set ownership to match systemd User: `chown nobody:nogroup /etc/chisel/auth.json`
- Log: `log_info "Auth file created: /etc/chisel/auth.json (chmod 600)"`
  </action>
  <verify>
Run `bash -n proxyebator.sh` --- must exit 0.
Run `grep -c 'server_download_chisel\|server_setup_auth\|CHISEL_FALLBACK_VER\|auth.json' proxyebator.sh` --- must find all function definitions and key strings.
Verify auth.json format: `grep '"\.\*:\.\*"' proxyebator.sh` --- must find the correct remote pattern.
Verify NO `--auth` flag in the file (only `--authfile`): `grep -c '\-\-auth ' proxyebator.sh` should be 0 or only in comments.
  </verify>
  <done>
server_download_chisel fetches latest Chisel version from GitHub API with v1.11.3 fallback, downloads the .gz asset using $ARCH, installs to /usr/local/bin/chisel. server_setup_auth creates /etc/chisel/auth.json with [".*:.*"] pattern, chmod 600, chown nobody:nogroup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement systemd service creation and wire into server_main</name>
  <files>proxyebator.sh</files>
  <action>
Add one function and update server_main().

**server_create_systemd():**
- Write the systemd unit file to /etc/systemd/system/proxyebator.service:
  ```ini
  [Unit]
  Description=Chisel Tunnel Server (proxyebator)
  After=network.target

  [Service]
  ExecStart=/usr/local/bin/chisel server \
    --host 127.0.0.1 \
    -p 7777 \
    --authfile /etc/chisel/auth.json \
    --socks5
  Restart=always
  RestartSec=5
  User=nobody
  Group=nogroup

  [Install]
  WantedBy=multi-user.target
  ```
- CRITICAL flags to verify in the template:
  - `--host 127.0.0.1` and `-p 7777` are SEPARATE arguments (Chisel ignores host in combined form)
  - `--authfile` NOT `--auth` (credentials not visible in ps aux)
  - `--socks5` enables SOCKS5
  - `--reverse` is NOT included (not needed for SOCKS5, increases attack surface)
  - `User=nobody Group=nogroup` --- unprivileged execution
  - Do NOT use `DynamicUser=yes` (changes UID on restart, breaks authfile ownership)
- Reload and start:
  ```bash
  systemctl daemon-reload
  systemctl enable --now proxyebator || die "Failed to start proxyebator.service"
  ```
- Log status: `log_info "Chisel systemd service: $(systemctl is-active proxyebator 2>/dev/null || echo 'unknown')"`

**Update server_main():**
Add the three new function calls after server_install_deps:
```bash
server_main() {
    check_root
    detect_os
    detect_arch
    server_collect_params
    server_show_summary
    server_install_deps
    server_download_chisel
    server_setup_auth
    server_create_systemd
    # Phase 2 Plan 03+ will add: server_configure_nginx, server_obtain_tls,
    # server_configure_firewall, server_save_config, server_verify
    log_warn "Phase 2 Plan 02 complete: Chisel installed and running. Remaining: nginx, TLS, firewall."
}
```
  </action>
  <verify>
Run `bash -n proxyebator.sh` --- must exit 0.
Verify systemd template: `grep -A 15 'proxyebator.service' proxyebator.sh` --- must show --host 127.0.0.1 and -p 7777 as separate flags, --authfile, --socks5, User=nobody.
Verify NO --reverse: `grep -c '\-\-reverse' proxyebator.sh` --- must be 0.
Verify server_main order: `grep -A 15 'server_main()' proxyebator.sh` --- must show server_download_chisel, server_setup_auth, server_create_systemd after server_install_deps.
  </verify>
  <done>
proxyebator.service systemd unit uses --host 127.0.0.1 -p 7777 (separate), --authfile, --socks5, User=nobody, Restart=always. server_main is updated to call server_download_chisel -> server_setup_auth -> server_create_systemd in sequence.
  </done>
</task>

</tasks>

<verification>
1. `bash -n proxyebator.sh` exits 0
2. Three new functions exist: server_download_chisel, server_setup_auth, server_create_systemd
3. Chisel download uses ${ARCH} not hardcoded amd64
4. Auth file uses [".*:.*"] not [""]
5. systemd unit has --host and -p as separate flags
6. No --reverse flag anywhere in the file
7. No --auth (without file) in ExecStart
8. server_main calls all functions in correct order
</verification>

<success_criteria>
- Chisel download function handles version detection with fallback
- Auth file created with correct format, permissions (600), ownership (nobody:nogroup)
- systemd service uses correct separate --host/-p flags
- Service enables and starts with restart on crash
- server_main updated with full call chain through systemd creation
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-core/02-02-SUMMARY.md`
</output>
