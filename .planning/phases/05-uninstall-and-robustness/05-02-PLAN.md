---
phase: 05-uninstall-and-robustness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - proxyebator.sh
autonomous: true
requirements:
  - SCRIPT-04
  - TUNNEL-07

must_haves:
  truths:
    - "Re-running ./proxyebator.sh server on an already-configured server skips binary download, auth file creation, systemd service creation, and config save"
    - "Re-running server does not overwrite /etc/chisel/auth.json (existing client connections are preserved)"
    - "Re-running server does not overwrite /etc/proxyebator/server.conf (stored credentials match running auth.json)"
    - "Re-running server does not re-download chisel binary if /usr/local/bin/chisel already exists"
    - "Re-running server does not recreate systemd unit if proxyebator.service is already active"
    - "Chisel auth credentials do not appear in ps aux output (--authfile pattern, not --auth CLI args)"
    - "server_collect_params re-sources existing server.conf to preserve secrets instead of generating new ones"
  artifacts:
    - path: "proxyebator.sh"
      provides: "Idempotency guards in server_download_chisel, server_setup_auth, server_create_systemd, server_save_config, server_collect_params"
      contains: "already installed"
  key_links:
    - from: "server_download_chisel"
      to: "/usr/local/bin/chisel"
      via: "existence check before download"
      pattern: "-x /usr/local/bin/chisel"
    - from: "server_setup_auth"
      to: "/etc/chisel/auth.json"
      via: "existence check before overwrite"
      pattern: "-f /etc/chisel/auth.json"
    - from: "server_create_systemd"
      to: "systemctl is-active"
      via: "active check before unit creation"
      pattern: "is-active.*proxyebator"
    - from: "server_collect_params"
      to: "/etc/proxyebator/server.conf"
      via: "source existing config to preserve secrets"
      pattern: "source /etc/proxyebator/server.conf"
---

<objective>
Add idempotency guards to the four server install functions that currently overwrite on re-run, and verify credential hygiene (TUNNEL-07).

Purpose: Users must be able to re-run `./proxyebator.sh server` on an already-configured server without breaking the existing installation. Existing binary, auth tokens, systemd service, and config must be preserved. Credentials must never appear in `ps aux`.

Output: Modified server install functions that detect existing state and skip, plus server_collect_params that re-sources existing config.
</objective>

<execution_context>
@/home/kosya/.claude/get-shit-done/workflows/execute-plan.md
@/home/kosya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-uninstall-and-robustness/05-RESEARCH.md
@proxyebator.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add idempotency guards to server_download_chisel, server_setup_auth, server_create_systemd, server_save_config</name>
  <files>proxyebator.sh</files>
  <action>
Add early-return guards to four functions. Each guard checks for existing state and returns early with a log_info message. This follows the exact pattern already used in `client_download_chisel()` (line ~258) and `server_install_deps()` (line ~552).

1. **server_download_chisel() — line 589:**
   Add at the very top of the function (before CHISEL_FALLBACK_VER):
   ```bash
   if [[ -x /usr/local/bin/chisel ]]; then
       log_info "Chisel already installed: $(/usr/local/bin/chisel --version 2>&1 | head -1)"
       return
   fi
   ```
   This mirrors the client-side pattern from `client_download_chisel()` (lines 258-261). We check `-x` (executable) not just `-f` (exists) to ensure the binary is functional. Do NOT attempt version comparison — that is v2 scope (UPD-01).

   Also add defensive cleanup at the start of the download section (after the guard):
   ```bash
   rm -f /tmp/chisel.gz /tmp/chisel 2>/dev/null || true
   ```
   This prevents stale temp files from a previous failed download from interfering.

2. **server_setup_auth() — line 615:**
   Add at the very top of the function (before mkdir):
   ```bash
   if [[ -f /etc/chisel/auth.json ]]; then
       log_info "Auth file already exists at /etc/chisel/auth.json — skipping generation"
       return
   fi
   ```
   This prevents regenerating the auth token, which would break existing client connections. The existing token is already in memory from server_collect_params (see Task 2 below).

3. **server_create_systemd() — line 634:**
   Add at the very top of the function:
   ```bash
   if systemctl is-active --quiet proxyebator 2>/dev/null; then
       log_info "proxyebator.service is already active — skipping service creation"
       return
   fi
   ```
   Uses `is-active` (not `is-enabled`): an enabled-but-stopped service should be recreated (might have a stale unit file).

4. **server_save_config() — line 947:**
   Add at the very top of the function (before mkdir):
   ```bash
   if [[ -f /etc/proxyebator/server.conf ]]; then
       log_info "Config already exists at /etc/proxyebator/server.conf — skipping"
       return
   fi
   ```
   This is critical because server_save_config writes AUTH_TOKEN to disk. If server_setup_auth skipped (auth.json exists), but server_save_config did NOT skip, it would write a NEW generated AUTH_TOKEN that does not match the auth.json. This is Pitfall 5 from research.
  </action>
  <verify>
Run: `bash -n proxyebator.sh` — must exit 0.
Run: `grep -n 'already installed\|already exists\|already active' proxyebator.sh` — should show 4 new guard messages (one per function), plus the pre-existing one in client_download_chisel and server_install_deps.
Run: `grep -c 'return' proxyebator.sh` — count should increase by 4 (one return per guard).
  </verify>
  <done>
Four server functions have existence guards that prevent overwriting on re-run. Binary, auth file, systemd service, and config are all preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add re-run awareness to server_collect_params and verify TUNNEL-07 compliance</name>
  <files>proxyebator.sh</files>
  <action>
Two changes: (A) make server_collect_params source existing config on re-run, (B) add TUNNEL-07 verification comment.

**A. Modify server_collect_params() (line 488):**

The problem: on re-run, `server_collect_params()` generates NEW `SECRET_PATH` and `AUTH_TOKEN` values (lines 509-511). Even though `server_save_config` will skip (Task 1 guard), the new values are used by `server_configure_nginx` and `verify_main`. This creates inconsistency.

Add at the very top of server_collect_params(), BEFORE the CLI_MODE check:
```bash
# Re-run detection: if server.conf already exists, source it to preserve
# existing secrets (SECRET_PATH, AUTH_TOKEN) and parameters.
# This prevents generating new credentials that would mismatch the
# running auth.json and the existing nginx tunnel block.
if [[ -f /etc/proxyebator/server.conf ]]; then
    log_info "Existing installation detected — loading saved configuration"
    # shellcheck disable=SC1091
    source /etc/proxyebator/server.conf
    # Set variables that server.conf uses different names for
    NGINX_CONF_PATH="${NGINX_CONF:-}"
    log_info "Re-run mode: domain=${DOMAIN:-} port=${LISTEN_PORT:-} tunnel=${TUNNEL_TYPE:-}"
    return
fi
```

This means on re-run:
- `DOMAIN`, `LISTEN_PORT`, `SECRET_PATH`, `AUTH_USER`, `AUTH_TOKEN`, `MASQUERADE_MODE`, `NGINX_CONF` are all loaded from existing config
- No interactive prompts are shown
- No new secrets are generated
- `server_show_summary` sees real values and either confirms or auto-skips (CLI_MODE)
- `server_configure_nginx` uses the correct `SECRET_PATH` from the existing config
- `verify_main` uses the correct values for all 7 checks

After adding the guard, also ensure the variables that `server_show_summary` and downstream functions expect are set. `NGINX_CONF_PATH` is set from `NGINX_CONF`. The `PROXY_URL` and `STATIC_PATH` variables are used by `generate_masquerade_block` — they will be empty strings on re-run (server.conf does not store PROXY_URL for "proxy" mode). This is acceptable because nginx config already exists and will not be rewritten.

**B. TUNNEL-07 verification comment:**

Add a comment block above the `server_create_systemd()` function (or inside it, near the ExecStart line), documenting the credential hygiene:
```bash
# TUNNEL-07 compliance: credentials are passed via --authfile, NOT --auth.
# This ensures AUTH_TOKEN never appears in /proc/PID/cmdline or ps aux output.
# The auth file /etc/chisel/auth.json is chmod 600, owned by nobody:nogroup.
# Verification: ps aux | grep chisel shows --authfile path, not credentials.
```

This comment serves as documentation for future maintainers and for the verification step.

**C. Add re-run bypass to server_show_summary():**

Modify `server_show_summary()` (line ~518) to also skip in re-run mode. Add at the top, after the CLI_MODE check:
```bash
# Re-run mode: skip confirmation if config already exists
if [[ -f /etc/proxyebator/server.conf ]]; then
    log_info "Re-run mode: skipping installation summary"
    return
fi
```
This prevents showing a confusing summary when the user is just re-running to verify/fix.
  </action>
  <verify>
Run: `bash -n proxyebator.sh` — must exit 0.
Run: `grep -n 'Re-run\|re-run\|TUNNEL-07' proxyebator.sh` — should show the re-run guard in server_collect_params, server_show_summary, and the TUNNEL-07 comment.
Run: `grep -n 'source /etc/proxyebator/server.conf' proxyebator.sh` — should show occurrences in verify_main (existing), uninstall_main (Plan 01), and server_collect_params (new).
Verify no duplicate variable initialization: `grep -c 'AUTH_TOKEN=' proxyebator.sh` — count should be reasonable (config save + generation + source load).
  </verify>
  <done>
server_collect_params detects existing installation and sources config instead of regenerating secrets. server_show_summary skips on re-run. TUNNEL-07 compliance is documented. Re-running server on configured host skips all already-complete steps.
  </done>
</task>

</tasks>

<verification>
1. `bash -n proxyebator.sh` exits 0 — no syntax errors
2. Four idempotency guards present: server_download_chisel, server_setup_auth, server_create_systemd, server_save_config
3. server_collect_params sources existing server.conf on re-run
4. server_show_summary skips on re-run
5. TUNNEL-07 comment block present near ExecStart
6. No new secret generation when server.conf already exists
7. Verify TUNNEL-07: ExecStart uses `--authfile` not `--auth` (already true, just confirm)
</verification>

<success_criteria>
- Re-running `./proxyebator.sh server` on configured host: each function logs "already installed/exists/active" and returns early
- Existing AUTH_TOKEN and SECRET_PATH are preserved from server.conf
- No interactive prompts on re-run
- --authfile pattern confirmed in systemd unit (TUNNEL-07)
- bash -n passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-uninstall-and-robustness/05-02-SUMMARY.md`
</output>
